apiVersion: apps/v1
kind: Deployment
metadata:
  name: tarka-webhook
  namespace: tarka
spec:
  replicas: 1
  selector:
    matchLabels:
      app: tarka-webhook
  template:
    metadata:
      labels:
        app: tarka-webhook
    spec:
      serviceAccountName: tarka
      containers:
        - name: tarka
          image: REPLACE_ME_IMAGE
          imagePullPolicy: Always
          command: ["python", "main.py"]
          args: ["--serve-webhook", "--host", "0.0.0.0", "--port", "8080"]
          ports:
            - name: http
              containerPort: 8080
          resources:
            # Increased memory after OOM kills (exit 137) - webhook loads LangChain + LLM libs
            requests:
              cpu: "50m"
              memory: "512Mi"
            limits:
              cpu: "500m"
              memory: "1Gi"
          envFrom:
            - configMapRef:
                name: tarka-config
          env:
            - name: AWS_REGION
              valueFrom:
                configMapKeyRef:
                  name: tarka-config
                  key: AWS_REGION
            - name: AWS_DEFAULT_REGION
              valueFrom:
                configMapKeyRef:
                  name: tarka-config
                  key: AWS_REGION
            # LLM integration (optional) uses Vertex AI via ADC.
            # LLM_* and GOOGLE_CLOUD_* non-secret config comes from envFrom `tarka-config`.
            # Optional: Postgres password for memory store. This secret exists only when
            # you provision it (dev via ExternalSecret, or RDS).
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: tarka
                  key: POSTGRES_PASSWORD
                  optional: true
            # Optional: Postgres DSN (overrides POSTGRES_HOST/PORT/DB/USER/PASSWORD).
            - name: POSTGRES_DSN
              valueFrom:
                secretKeyRef:
                  name: tarka
                  key: POSTGRES_DSN
                  optional: true
            # Optional: LangSmith API key for tracing (enabled via LANGSMITH_TRACING=true).
            - name: LANGSMITH_API_KEY
              valueFrom:
                secretKeyRef:
                  name: tarka
                  key: LANGSMITH_API_KEY
                  optional: true
            # Optional: Anthropic API key for LLM (when LLM_PROVIDER=anthropic).
            - name: ANTHROPIC_API_KEY
              valueFrom:
                secretKeyRef:
                  name: tarka
                  key: ANTHROPIC_API_KEY
                  optional: true
            # GitHub App credentials (required when GITHUB_EVIDENCE_ENABLED=1 or CHAT_ALLOW_GITHUB_READ=1)
            - name: GITHUB_APP_ID
              valueFrom:
                secretKeyRef:
                  name: tarka
                  key: GITHUB_APP_ID
                  optional: true
            - name: GITHUB_APP_PRIVATE_KEY
              valueFrom:
                secretKeyRef:
                  name: tarka
                  key: GITHUB_APP_PRIVATE_KEY
                  optional: true
            - name: GITHUB_APP_INSTALLATION_ID
              valueFrom:
                secretKeyRef:
                  name: tarka
                  key: GITHUB_APP_INSTALLATION_ID
                  optional: true
            # Console API auth (Google SSO / OIDC)
            # Note: during staging cutover you can set this to "both" to allow Basic+OIDC temporarily.
            - name: CONSOLE_AUTH_MODE
              value: "oidc"
            - name: JETSTREAM_DUPLICATE_WINDOW_SECONDS
              value: "3600"
            - name: GOOGLE_OAUTH_CLIENT_ID
              valueFrom:
                secretKeyRef:
                  name: tarka
                  key: GOOGLE_OAUTH_CLIENT_ID
                  optional: true
            - name: GOOGLE_OAUTH_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: tarka
                  key: GOOGLE_OAUTH_CLIENT_SECRET
                  optional: true
            - name: AUTH_SESSION_SECRET
              valueFrom:
                secretKeyRef:
                  name: tarka
                  key: AUTH_SESSION_SECRET
                  optional: true
            - name: AUTH_PUBLIC_BASE_URL
              valueFrom:
                configMapKeyRef:
                  name: tarka-config
                  key: AUTH_PUBLIC_BASE_URL
                  optional: true
            - name: AUTH_ALLOWED_DOMAINS
              valueFrom:
                configMapKeyRef:
                  name: tarka-config
                  key: AUTH_ALLOWED_DOMAINS
                  optional: true
            # Local auth admin user (initial setup)
            - name: ADMIN_INITIAL_USERNAME
              valueFrom:
                secretKeyRef:
                  name: tarka
                  key: ADMIN_INITIAL_USERNAME
                  optional: true
            - name: ADMIN_INITIAL_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: tarka
                  key: ADMIN_INITIAL_PASSWORD
                  optional: true
            # OIDC authentication (optional)
            - name: OIDC_DISCOVERY_URL
              valueFrom:
                secretKeyRef:
                  name: tarka
                  key: OIDC_DISCOVERY_URL
                  optional: true
            - name: OIDC_CLIENT_ID
              valueFrom:
                secretKeyRef:
                  name: tarka
                  key: OIDC_CLIENT_ID
                  optional: true
            - name: OIDC_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: tarka
                  key: OIDC_CLIENT_SECRET
                  optional: true
            # Chat/actions policy flags are provided via envFrom `tarka-config`.
            # Console API auth (Basic) - transitional only (CONSOLE_AUTH_MODE=basic|both)
            - name: CONSOLE_AUTH_USERNAME
              valueFrom:
                secretKeyRef:
                  name: tarka
                  key: CONSOLE_AUTH_USERNAME
                  optional: true
            - name: CONSOLE_AUTH_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: tarka
                  key: CONSOLE_AUTH_PASSWORD
                  optional: true
          volumeMounts:
            - name: gcp-wif-cred
              mountPath: /var/run/gcp
              readOnly: true
            # Projected OIDC token with a custom audience for Google WIF.
            # IMPORTANT: set `audience` below to match the `audience` field in your GCP_WIF_CRED_JSON.
            - name: gcp-oidc-token
              mountPath: /var/run/gcp/oidc
              readOnly: true
            - name: service-catalog
              mountPath: /app/config
              readOnly: true
          readinessProbe:
            httpGet:
              path: /healthz
              port: http
            initialDelaySeconds: 2
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 6
          startupProbe:
            httpGet:
              path: /healthz
              port: http
            # Give the container time to initialize (imports, boto/psycopg, etc.)
            periodSeconds: 3
            timeoutSeconds: 2
            failureThreshold: 40
          livenessProbe:
            httpGet:
              path: /healthz
              port: http
            initialDelaySeconds: 5
            periodSeconds: 20
            timeoutSeconds: 5
            failureThreshold: 6
      volumes:
        - name: service-catalog
          configMap:
            name: tarka-service-catalog
        - name: gcp-wif-cred
          secret:
            # Client library config JSON is a secret (synced from AWS Secrets Manager via ExternalSecrets).
            secretName: tarka
            items:
              - key: GCP_WIF_CRED_JSON
                path: wif-cred.json
        - name: gcp-oidc-token
          projected:
            sources:
              - serviceAccountToken:
                  # Replace with your Google Workload Identity Provider audience, e.g.:
                  # //iam.googleapis.com/projects/123456789/locations/global/workloadIdentityPools/POOL/providers/PROVIDER
                  audience: "REPLACE_ME_GCP_WIF_AUDIENCE"
                  expirationSeconds: 3600
                  path: token
